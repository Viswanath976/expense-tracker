<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Smart Expense Tracker</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body class="bg-light">

<div class="container mt-4">

    <!-- Heading -->
    <h2 class="text-center mb-4 fw-bold">
        ðŸ’° Smart Expense Tracker
    </h2>

    <!-- Filter Row -->
    <div class="row align-items-center mb-3">
        <div class="col-md-3">
            <input type="month" id="monthPicker" class="form-control">
        </div>
        <div class="col-md-2">
            <button class="btn btn-secondary w-100" onclick="filterByMonth()">Filter</button>
        </div>
        <div class="col-md-4 fs-5 fw-bold">
            Total: â‚¹ <span id="totalAmount">0</span>
        </div>
    </div>

    <!-- Add Expense -->
    <div class="card mb-3">
        <div class="card-body">
            <form id="expenseForm" class="row g-2">
                <div class="col">
                    <input class="form-control" id="title" placeholder="Title" required>
                </div>
                <div class="col">
                    <input class="form-control" id="amount" type="number" placeholder="Amount" required>
                </div>
                <div class="col">
                    <select class="form-select" id="category" required>
    <option value="">Select Type</option>
    <option value="INCOME">Income</option>
    <option value="EXPENSE">Expense</option>
</select>
                </div>
                <div class="col">
                    <input class="form-control" id="date" type="date" required>
                </div>
                <div class="col">
                    <button class="btn btn-primary w-100">Add</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Table -->
    <table class="table table-bordered table-striped text-center">
        <thead class="table-dark">
        <tr>
            <th>Title</th>
            <th>Amount</th>
            <th>Category</th>
            <th>Date</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody id="expenseTable"></tbody>
    </table>

    <!-- Chart -->
    <div class="card p-3">
        <!-- <canvas id="expenseChart"></canvas> -->
        <canvas id="expenseChart" width="868" height="925" style="display: block; box-sizing: initial; height: 740.4px; width: 694.4px;"></canvas>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Edit Expense</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editId">
                <input class="form-control mb-2" id="editTitle">
                <input class="form-control mb-2" id="editAmount" type="number">
                <select class="form-select mb-2" id="editCategory">
    <option value="INCOME">Income</option>
    <option value="EXPENSE">Expense</option>
</select>
                <input class="form-control" id="editDate" type="date">
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" onclick="updateExpense()">Update</button>
            </div>
        </div>
    </div>
</div>

<script>
const API = "http://localhost:8080/api/expenses";
let chart;

window.onload = loadAll;

function loadAll() {
    fetch(API).then(r=>r.json()).then(render);
}

function render(data) {
    let table = document.getElementById("expenseTable");
    let total = 0;
    let income = 0;
    let expense = 0;

    table.innerHTML = "";

    data.forEach(e => {
        total += e.amount;

        if (e.category === "INCOME") income += e.amount;
        else expense += e.amount;

        table.innerHTML += `
        <tr>
            <td>${e.title}</td>
            <td>${e.amount}</td>
            <td>${e.category}</td>
            <td>${e.date}</td>
            <td>
                <button class="btn btn-warning btn-sm"
                    onclick="openEdit(${JSON.stringify(e).replace(/"/g,'&quot;')})">
                    Edit
                </button>
                <button class="btn btn-danger btn-sm" onclick="del(${e.id})">
                    Delete
                </button>
            </td>
        </tr>`;
    });

    document.getElementById("totalAmount").innerText = total;

    drawChart(income, expense);
}


function filterByMonth() {
    let [year, month] = document.getElementById("monthPicker").value.split("-");
    fetch(`${API}/month?year=${year}&month=${month}`).then(r=>r.json()).then(render);
}

function del(id) {
    fetch(`${API}/${id}`, { method:"DELETE" }).then(loadAll);
}

document.getElementById("expenseForm").onsubmit = e => {
    e.preventDefault();
    fetch(API, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
            title:title.value,
            amount:amount.value,
            category:category.value,
            date:date.value
        })
    }).then(()=>{ e.target.reset(); loadAll(); });
};

function openEdit(e) {
    editId.value = e.id;
    editTitle.value = e.title;
    editAmount.value = e.amount;
    editCategory.value = e.category;
    editDate.value = e.date;
    new bootstrap.Modal(document.getElementById("editModal")).show();
}

function updateExpense() {
    fetch(`${API}/${editId.value}`, {
        method:"PUT",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
            title:editTitle.value,
            amount:editAmount.value,
            category:editCategory.value,
            date:editDate.value
        })
    }).then(()=>{ bootstrap.Modal.getInstance(editModal).hide(); loadAll(); });
}

function drawChart(income, expense) {
    if (chart) chart.destroy();

    chart = new Chart(document.getElementById("expenseChart"), {
        type: "pie",
        data: {
            labels: ["Income", "Expense"],
            datasets: [{
                data: [income, expense],
                backgroundColor: ["#198754", "#dc3545"]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}
</script>

</body>
</html>
